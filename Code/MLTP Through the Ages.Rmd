---
title: "<center>MLTP: Data Visualization Through the Ages</center>"
author: "<center>Jay Shapiro</center>"
date: "<center>TBD</center>"
output: 
  html_document:
    theme: cerulean
  pdf_document: default 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

<br><br>

MLTP is the premiere level of competitive Tagpro in North America. Tagpro is a capture the flag game played between two teams of four players; each team typically has two offenders and two defenders in the competitive meta. This data visualization project will showcase some of the primary metrics used to evaluate players and how the stats have changed across modern competitive seasons.

The main statistics used to judge the individual performance of an offender are captures, grabs, scoring percentage, and hold. Captures is the number of times an offender scored, grabs is the number of times an offender picked up the flag, scoring percentage is simply (captures/grabs)*100, the percentage of grabs that result in a capture, and hold is the duration of time an offender has the flag in their possession. 

Defenders are mainly judged individually on prevent, tags, and kill/death ratio. Prevent is the duration of time the defender protected the flag from being grabbed, tags are the number of times a player kills a player on the other team, and kill/death ratio is (unsurprisingly) the number of tags divided by the number of deaths.

Finally, team success is typically measured in either win/loss/tie record or by score differential. I will use score differential for the purposes of this data visualization, as a quantitative measure of success is more useful in this case than a qualitative one, as winning by one capture is a much smaller indicator of success than winning by ten captures. 

<br><br>

##  Exploration

<br><br>

### Part I: Defense Scatterplots

<br><br>

First, we consider a handful of interactive scatterplots comparing some of the defensive metrics to each other. In each plot, the size of the data point depicts the score differential per minute for that observation. Hovering over each observation will provide the player's name and their x and y axis values. Each plot also has a slider that controls which season is displayed on the graph; hitting 'Play" will have the plot cycle autonomously through the seasons for a full rotation, and each season can also be directly clicked on manually to jump around. 

First, we compare tags per minute to prevent per minute, colored by the main position of the player in each observation. Comparing the two groups, defenders and offenders, gives a schema for what kind of stats a player should be getting for their position: 

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(ggplot2)
library(ggfortify)
library(plotly)
library(data.table)
library(factoextra)
library(pls)
library(beeswarm)

MLTPfiles <- list.files(path = "C:/Users/jays/Desktop/Tagpro/MLTP_Stats/",
                        pattern = "*.tsv", full.names = TRUE)

MLTP_master_stats <- data.frame()

for (lambda in c(1:10)) {
  location <- MLTPfiles[lambda]
  temp <- fread(file = location, 
                sep = "\t", fill = TRUE, header = TRUE) %>% mutate(season = as.factor(lambda + 9))
  
  MLTP_master_stats <- rbind(MLTP_master_stats, temp)
}

#str(MLTP_master_stats)

MLTP_normalized_stats<- mutate(MLTP_master_stats, scpm = score/minutes, success_rate = pm/minutes, tpm = tags/minutes, 
                               poppm = pops/minutes, droppm = drops/minutes, gpm = grabs/minutes,
                               hpm = hold/minutes, cpm = captures/minutes, ppm = prevent/minutes, rpm = returns/minutes,
                               pupm = pups/minutes, kdr = tags/pops, limp = flaccids/minutes, LHpm = longholds/minutes, 
                               handpm = handoff/minutes, GHpm = goodhandoff/minutes, gorepm = goregrab/minutes, corepm = coregrab/minutes,
                               copm = cohandoff/minutes, inbasepm = retinbase/minutes, quickpm = quickret/minutes, savepm = saves/minutes,
                               HApm = holdagainst/minutes)

MLTP_filtered_stats <- MLTP_normalized_stats %>%
  filter(minutes >= 120) %>%
  select(-c(V28, team, pupscomp, score, minutes, pm, tags, pops, grabs, drops, hold, captures, prevent, returns,
            pups, pupscomp, flaccids, longholds, handoff, goodhandoff, goregrab, gohandoff, cohandoff, retinbase,
            quickret, saves, holdagainst, coregrab)) %>%
    mutate(position = ifelse(ppm > hpm, "Defense", "Offense"))

MLTP_defense_stats <- MLTP_filtered_stats %>%
  filter(ppm > hpm)

MLTP_offense_stats <- MLTP_filtered_stats %>%
  filter(hpm > ppm)

ppm_tpm_all <- MLTP_filtered_stats %>%
  plot_ly(
    x = ~ppm, 
    y = ~tpm, 
    size = ~success_rate, 
    color = ~position, 
    frame = ~season, 
    text = ~player, 
    hovertemplate = paste("<b>%{text}</b><br><br>",
                          "%{yaxis.title.text}: %{y}<br>",
                          "%{xaxis.title.text}: %{x}<br>",
                          "<extra></extra>"),
    type = 'scatter',
    mode = 'markers'
  ) %>%
    animation_opts(frame = 1500, easing = NULL, redraw = FALSE) %>%
      layout(scene = list(xaxis = list(title = 'Prevent Per Minute'),
                          yaxis = list(title = 'Tags Per Minute')),
                          title = "PPM vs TPM for Both Positions")

ppm_tpm_all
```

<br><br>

Next, we remove the offenders from the mix to only see the plot for the defenders. Although seeing the positional differences was useful, reducing the domain and and range of the axes provides a better picture of the subset of players for which the stats are actually important:

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
ppm_tpm_d <- MLTP_defense_stats %>%
  plot_ly(
    x = ~ppm, 
    y = ~tpm, 
    size = ~success_rate, 
    color = ~position, 
    frame = ~season, 
    text = ~player, 
    hovertemplate = paste("<b>%{text}</b><br><br>",
                    "%{yaxis.title.text}: %{y}<br>",
                    "%{xaxis.title.text}: %{x}<br>",
                    "<extra></extra>"),
    type = 'scatter',
    mode = 'markers'
  ) %>%
  animation_opts(frame = 1500, easing = NULL, redraw = FALSE) %>%
    layout(scene = list(xaxis = list(title = 'Prevent Per Minute'),
                        yaxis = list(title = 'Tags Per Minute')),
                        title = "PPM vs TPM for Defenders")

ppm_tpm_d
```

<br><br>

### Part II: Offense Scatterplots

<br><br>

Now we employ the same technique for hold per minute compared to grabs per minute, again presenting both positions separated by color, and then a subset including only the offenders:

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
hpm_gpm_all <- MLTP_filtered_stats %>%
  plot_ly(
    x = ~gpm, 
    y = ~hpm, 
    size = ~success_rate, 
    color = ~position, 
    frame = ~season, 
    text = ~player, 
    hovertemplate = paste("<b>%{text}</b><br><br>",
                    "%{yaxis.title.text}: %{y}<br>",
                    "%{xaxis.title.text}: %{x}<br>",
                    "<extra></extra>"),
    type = 'scatter',
    mode = 'markers'
  ) %>%
  animation_opts(frame = 1500, easing = NULL, redraw = FALSE) %>%
    layout(scene = list(xaxis = list(title = 'Grabs Per Minute'),
                        yaxis = list(title = 'Hold Per Minute')),
                        title = "GPM vs HPM for Both Positions")

hpm_gpm_all
```

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
hpm_gpm_o <- MLTP_offense_stats %>%
  plot_ly(
    x = ~gpm, 
    y = ~hpm, 
    size = ~success_rate, 
    color = ~position, 
    frame = ~season, 
    text = ~player, 
    hovertemplate = paste("<b>%{text}</b><br><br>",
                    "%{yaxis.title.text}: %{y}<br>",
                    "%{xaxis.title.text}: %{x}<br>",
                    "<extra></extra>"),
    type = 'scatter',
    mode = 'markers'
  ) %>%
  animation_opts(frame = 1500, easing = NULL, redraw = FALSE) %>%
    layout(scene = list(xaxis = list(title = 'Grabs Per Minute'),
                        yaxis = list(title = 'Hold Per Minute')),
                        title = "GPM vs HPM for Offenders")

hpm_gpm_o
```

<br><br>

### Part III: Distribution Visualization

<br><br>

Beeswarm plots are a magnificent way to visualize distributions of MLTP stats. Beeswarms show the individual observations as unique data points, unlike other distribution visualization techniques which often encode the data abstractly. For example, boxplots uses a box and whiskers to encapsulate all of the non-outlier observations and rely on quartiles and summary statistics. Histograms employ binning to group the data points into bars to display, again obscuring the individual observations. One of the main limitations of beeswarm plots is that for increasingly large datasets, it becomes more and more difficult to show each observation. Modern MLTP seasons typically have somewhere between 32 and 64 majors starters, depending on the number of teams. which falls into the optimal number of observations for a beeswarm plot.

To supplement each beeswarm plot, I have also included an interactive boxplot (a.k.a box-and-whiskers plot) with the individual data points slightly offset from the main body of the boxplot. Hovering over the box for each season will display the summary statistics for that box: Minimum, maximum, first quartile, third quartile, median, and upper fence. Hovering over each data point will give the player's name, the season the observation was from, and the value from the y-axis, which varies per plot. Toggling the colored boxes in the legend allows the box for each season to be removed or returned to the plot, and double-clicking on any of the boxes will display that season in isolation and remove all other seasons from the boxplot.

<br><br>

#### Section A: Prevent

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Prevent by defenders
beeswarm(ppm ~ season, data = MLTP_defense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Prevent Per Minute for Defenders ", xlab = "Season", ylab = "Prevent Per Minute",
         )

#Plotly inbound
prevent <- plot_ly(data= MLTP_defense_stats, x = ~season, y = ~ppm, color = ~season, type = "box", boxpoints = 'all',
             text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Prevent Per Minute')),
         title = "Prevent Per Minute for Defenders")
prevent
```

<br><br>

#### Section B: Tags

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Tags by defenders
beeswarm(tpm ~ season, data = MLTP_defense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Tags Per Minute for Defenders", xlab = "Season", ylab = "Tags Per Minute",
         )

#Plotly inbound
tags <- plot_ly(data= MLTP_defense_stats, x = ~season, y = ~tpm, color = ~season, type = "box", boxpoints = 'all',
             text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Tags Per Minute')),
         title = "Tags Per Minute for Defenders")
tags
```

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#KDR by defenders
beeswarm(kdr ~ season, data = MLTP_defense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Kill/Death Ratio by MLTP Season", xlab = "Season", ylab = "Kill/Death Ratio",
         )

#Plotly inbound
kdr <- plot_ly(data= MLTP_defense_stats, x = ~season, y = ~kdr, color = ~season, type = "box", boxpoints = 'all',
                text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Kill/Death Ratio')),
         title = "Kill/Death Ratio by MLTP Defenders")
kdr
```

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Hold by attackers

beeswarm(hpm ~ season, data = MLTP_offense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Hold Per Minute by MLTP Season", xlab = "Season", ylab = "Hold Per Minute",
         )

#Plotly inbound
hold <- plot_ly(data= MLTP_offense_stats, x = ~season, y = ~hpm, color = ~season, type = "box", boxpoints = 'all',
             text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Hold Per Minute')),
         title = "Hold Per Minute by MLTP Offenders")
hold
```

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Caps for attackers
beeswarm(cpm ~ season, data = MLTP_offense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Caps Per Minute by MLTP Season", xlab = "Season", ylab = "Captures Per Minute",
         )

caps <- plot_ly(data= MLTP_offense_stats, x = ~season, y = ~cpm, color = ~season, type = "box", boxpoints = 'all',
                text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Captures Per Minute')),
         title = "Captures Per Minute by MLTP Offenders")
caps
```

<br><br>

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Grabs for attackers
beeswarm(gpm ~ season, data = MLTP_offense_stats, pch = 16, col = rainbow(10), method = "hex",
         main = "Grabs Per Minute by MLTP Season", xlab = "Season", ylab = "Grabs Per Minute",
         )

grabs <- plot_ly(data= MLTP_offense_stats, x = ~season, y = ~gpm, color = ~season, type = "box", boxpoints = 'all',
                text = ~player) %>%
  layout(scene = list(xaxis = list(title = 'Season'),
                      yaxis = list(title = 'Grabs Per Minute')),
         title = "Grabs Per Minute by MLTP Offenders")
grabs
```

```{r echo = FALSE}
sessionInfo()
```